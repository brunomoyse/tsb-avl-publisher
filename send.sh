#!/usr/bin/env bash
set -euo pipefail

FULLHEX_NOCRC="00000000000003558e0a000001876f6d9000000f0db045209591780075011f0600080000000c000500ef0100f00100150500c800004501000500b5001b00b6001400423a3700430fe100440000000200f10000601a00100000248f00000000000001876f6dbee0000f0db22820959178007300770600070000000c000500ef0100f00100150500c800004501000500b5001d00b6001500423a3800430fe200440000000200f10000601a00100000249800000000000001876f6dda38000f0db08720959329007301260800080000000c000500ef0100f00100150500c800004501000500b5001100b6000a00423a3500430fe200440000000200f10000601a00100000249c00000000000001876f6e2470000f0dac2b2095964a007701040a00060000000c000500ef0100f00100150500c800004501000500b5000b00b6000800423a2c00430fe200440000000200f10000601a0010000024a900000000000001876f6e3410000f0da77b209596ad007901150a000f0000000c000500ef0100f00100150500c800004501000500b5001100b6000800423a2d00430fe100440000000200f10000601a0010000024b000000000000001876f6e3be0000f0da267209597fb007b011f0a00130000000c000500ef0100f00100150500c800004501000500b5001100b6000800423a3200430fe200440000000200f10000601a0010000024b900000000000001876f6e5350000f0d9907209599de008101060800080000000c000500ef0100f00100150500c800004501000500b5001300b6000b00423a3400430fe200440000000200f10000601a0010000024ca00000000000001876f6e7a60000f0d9e4d209598b2008100800900060000000c000500ef0100f00100150500c800004501000500b5000c00b6000900423a3200430fe200440000000200f10000601a0010000024d400000000000001876f6e7e48000f0da2672095986f0081007409000b0000000c000500ef0100f00100150500c800004501000500b5001100b6000a00423a2e00430fe200440000000200f10000601a0010000024db00000000000001876f6e8618000f0da8752095984e0080006a0900070000000c000500ef0100f00100150500c800004501000500b5001100b6000a00423a1900430fdf00440000000200f10000601a0010000024e5000000000a00005243"  # Your original hex string

# Calculate CRC-16/ARC over payload only (skip 8-byte header)
CRC4HEX=$(python3 -c "
import crcmod

# Create CRC-16/ARC calculator
crc16 = crcmod.mkCrcFun(
    initCrc=0x0000,
    poly=0x18005,
    rev=True,
    xorOut=0x0000
)

# Skip 8-byte header (4 zeros + 4-byte length) - hex offset 16
payload_hex = '${FULLHEX_NOCRC:16}'
data = bytes.fromhex(payload_hex)
print('%04X' % crc16(data))
")

# Build full packet with original header + length + payload + CRC
FULL_PACKET="${FULLHEX_NOCRC}${CRC4HEX}"
{
  printf '\x00\x0F123456789012345'  # IMEI handshake
  echo "$FULL_PACKET" | xxd -r -p
} | nc localhost 7494